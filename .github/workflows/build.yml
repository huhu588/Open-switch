name: Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: true
      build_macos:
        description: 'Build macOS'
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # 生成图标（所有平台共用）
  generate-icons:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install SVG converter
        run: sudo apt-get update && sudo apt-get install -y librsvg2-bin

      - name: Generate icons from SVG
        run: |
          cd src-tauri/icons
          # 使用 rsvg-convert 将 SVG 转为 PNG，避免 ImageMagick 的安全策略限制
          rsvg-convert -w 1024 -h 1024 app-icon.svg -o icon.png
          # 回到项目根目录，使用 Tauri CLI 生成全平台图标
          cd ../..
          npx @tauri-apps/cli icon src-tauri/icons/icon.png

      - name: Upload icons
        uses: actions/upload-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/
          retention-days: 1

  # macOS Universal (同时支持 Intel 和 Apple Silicon)
  build-macos:
    needs: generate-icons
    if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.build_macos) }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS targets
        run: |
          rustup target add aarch64-apple-darwin x86_64-apple-darwin

      # Rust 编译缓存 - 大幅加速后续构建
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app (Universal Binary)
        run: npm run tauri build -- --target universal-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Prepare macOS artifacts
        run: |
          mkdir -p release-assets
          VERSION="${GITHUB_REF_NAME:-dev}"
          
          # 查找 .tar.gz (用于 updater)
          TAR_GZ=$(find src-tauri/target/universal-apple-darwin/release/bundle -name "*.tar.gz" -type f | head -1)
          if [ -n "$TAR_GZ" ]; then
            cp "$TAR_GZ" "release-assets/"
            [ -f "$TAR_GZ.sig" ] && cp "$TAR_GZ.sig" "release-assets/"
            echo "Found updater artifact: $TAR_GZ"
          fi
          
          # 查找 .dmg (用于手动安装)
          DMG=$(find src-tauri/target/universal-apple-darwin/release/bundle -name "*.dmg" -type f | head -1)
          if [ -n "$DMG" ]; then
            cp "$DMG" "release-assets/"
            echo "Found DMG: $DMG"
          fi
          
          # 如果没有 .tar.gz，尝试查找 .app 并打包
          if [ -z "$TAR_GZ" ]; then
            APP=$(find src-tauri/target/universal-apple-darwin/release/bundle -name "*.app" -type d | head -1)
            if [ -n "$APP" ]; then
              APP_NAME=$(basename "$APP")
              cd "$(dirname "$APP")"
              tar -czf "$GITHUB_WORKSPACE/release-assets/${APP_NAME%.app}.tar.gz" "$APP_NAME"
              cd "$GITHUB_WORKSPACE"
              echo "Created tar.gz from .app"
            fi
          fi
          
          echo "=== Release assets ==="
          ls -la release-assets/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Open-Switch-macos
          path: release-assets/*

  # Windows
  build-windows:
    needs: generate-icons
    if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.build_windows) }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Rust 编译缓存 - 大幅加速后续构建
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build -- --bundles nsis
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Open-Switch-windows
          path: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig

  # 创建 Release 并生成 latest.json（支持全平台自动更新）
  release:
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f | head -50

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate latest.json for updater (全平台支持)
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          REPO="${{ github.repository }}"
          PUB_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          echo "=== Looking for signature files ==="
          find artifacts -name "*.sig" -type f 2>/dev/null || echo "No .sig files found"
          
          # 初始化签名和 URL 变量
          WIN_SIG=""
          WIN_URL=""
          MAC_SIG=""
          MAC_URL=""
          
          # ===== Windows =====
          SIGFILE=$(find artifacts -name "*.exe.sig" -type f | head -1)
          if [ -n "$SIGFILE" ] && [ -f "$SIGFILE" ]; then
            WIN_SIG=$(cat "$SIGFILE")
            echo "Found Windows signature: $SIGFILE"
          fi
          
          EXEFILE=$(find artifacts -name "*.exe" ! -name "*.exe.sig" -type f | head -1)
          if [ -n "$EXEFILE" ]; then
            EXENAME=$(basename "$EXEFILE" | sed 's/ /./g')
            WIN_URL="https://github.com/${REPO}/releases/download/v${VERSION}/${EXENAME}"
            echo "Windows URL: $WIN_URL"
          fi
          
          # ===== macOS =====
          MACSIGFILE=$(find artifacts -name "*.tar.gz.sig" -type f | head -1)
          if [ -n "$MACSIGFILE" ] && [ -f "$MACSIGFILE" ]; then
            MAC_SIG=$(cat "$MACSIGFILE")
            echo "Found macOS signature: $MACSIGFILE"
          fi
          
          MACFILE=$(find artifacts -name "*.tar.gz" ! -name "*.tar.gz.sig" -type f | head -1)
          if [ -n "$MACFILE" ]; then
            MACNAME=$(basename "$MACFILE" | sed 's/ /./g')
            MAC_URL="https://github.com/${REPO}/releases/download/v${VERSION}/${MACNAME}"
            echo "macOS URL: $MAC_URL"
          fi
          
          # ===== 生成 latest.json =====
          echo "Generating latest.json..."
          
          # 构建 platforms JSON
          PLATFORMS=""
          
          # 添加 Windows
          if [ -n "$WIN_SIG" ] && [ -n "$WIN_URL" ]; then
            PLATFORMS="\"windows-x86_64\": {\"signature\": \"$WIN_SIG\", \"url\": \"$WIN_URL\"}"
          fi
          
          # 添加 macOS (同时支持 Intel 和 Apple Silicon)
          if [ -n "$MAC_SIG" ] && [ -n "$MAC_URL" ]; then
            if [ -n "$PLATFORMS" ]; then
              PLATFORMS="$PLATFORMS,"
            fi
            # Universal binary 同时支持两种架构
            PLATFORMS="$PLATFORMS
    \"darwin-aarch64\": {\"signature\": \"$MAC_SIG\", \"url\": \"$MAC_URL\"},
    \"darwin-x86_64\": {\"signature\": \"$MAC_SIG\", \"url\": \"$MAC_URL\"}"
          fi
          
          # 写入 latest.json
          cat > artifacts/latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "Open Switch v$VERSION 发布",
            "pub_date": "$PUB_DATE",
            "platforms": {
              $PLATFORMS
            }
          }
          EOF
          
          echo "Generated latest.json:"
          cat artifacts/latest.json
          
          # 验证
          if [ -z "$WIN_SIG" ]; then
            echo "::warning::Windows signature is empty!"
          fi
          if [ -z "$MAC_SIG" ]; then
            echo "::warning::macOS signature is empty!"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.tar.gz
            artifacts/**/*.exe
            artifacts/**/*.sig
            artifacts/latest.json
          draft: false
          generate_release_notes: true
          fail_on_unmatched_files: false
