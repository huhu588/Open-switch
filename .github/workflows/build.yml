name: Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: true
      build_macos:
        description: 'Build macOS'
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # 生成图标（所有平台共用）
  generate-icons:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install SVG converter
        run: sudo apt-get update && sudo apt-get install -y librsvg2-bin

      - name: Generate icons from SVG
        run: |
          cd src-tauri/icons
          # 使用 rsvg-convert 将 SVG 转为 PNG，避免 ImageMagick 的安全策略限制
          rsvg-convert -w 1024 -h 1024 app-icon.svg -o icon.png
          # 回到项目根目录，使用 Tauri CLI 生成全平台图标
          cd ../..
          npx @tauri-apps/cli icon src-tauri/icons/icon.png

      - name: Upload icons
        uses: actions/upload-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/
          retention-days: 1

  # macOS Apple Silicon (M1/M2/M3)
  build-macos-arm64:
    needs: generate-icons
    if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.build_macos) }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      # Rust 编译缓存 - 大幅加速后续构建
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build -- --target aarch64-apple-darwin --bundles dmg
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Open-Switch-macos-arm64
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg

  # macOS Intel (x86_64)
  build-macos-x64:
    needs: generate-icons
    if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.build_macos) }}
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      # Rust 编译缓存 - 大幅加速后续构建
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build -- --target x86_64-apple-darwin --bundles dmg
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Open-Switch-macos-x64
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg

  # Windows (可选)
  build-windows:
    needs: generate-icons
    if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.build_windows) }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          path: src-tauri/icons/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Rust 编译缓存 - 大幅加速后续构建
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-on-failure: true

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build -- --bundles msi,nsis
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Open-Switch-windows
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.sig
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig

  # 创建 Release（仅在 tag 推送时，手动触发不会创建 Release）
  release:
    # 只在 tag 推送时运行，手动触发时跳过
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
    needs: [build-macos-arm64, build-macos-x64, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          # 合并所有同名 pattern 的 artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*.dmg" -o -name "*.msi" -o -name "*.exe" -o -name "*.sig" -o -name "*.json" | head -30

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate latest.json for updater
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          REPO="${{ github.repository }}"
          
          echo "=== Looking for signature files ==="
          find artifacts -name "*.sig" -type f 2>/dev/null || echo "No .sig files found"
          echo "=== All artifacts ==="
          find artifacts -type f | head -50
          
          # 读取 Windows NSIS 签名文件
          WIN_SIG=""
          # 使用 find 动态查找 exe.sig 文件
          SIGFILE=$(find artifacts -name "*.exe.sig" -type f | head -1)
          if [ -n "$SIGFILE" ] && [ -f "$SIGFILE" ]; then
            WIN_SIG=$(cat "$SIGFILE")
            echo "Found Windows signature at: $SIGFILE"
            echo "Signature content (first 100 chars): ${WIN_SIG:0:100}..."
          fi
          
          if [ -z "$WIN_SIG" ]; then
            echo "ERROR: No Windows signature file found! Updater will not work."
            echo "Available files:"
            find artifacts -type f
            # 不退出，但记录错误
          fi
          
          # 查找实际的 exe 文件名
          # 注意：Windows 构建的原始文件名可能带空格，但 GitHub Release 上传时会将空格转为点号
          EXEFILE=$(find artifacts -name "*.exe" ! -name "*.exe.sig" -type f | head -1)
          if [ -n "$EXEFILE" ]; then
            EXENAME=$(basename "$EXEFILE")
            # GitHub Release 会将文件名中的空格转换为点号，所以这里也需要做同样的转换
            EXENAME=$(echo "$EXENAME" | sed 's/ /./g')
          else
            # Fallback：使用 Tauri 的默认命名格式（点号代替空格）
            EXENAME="Open.Switch_${VERSION}_x64-setup.exe"
          fi
          echo "Found exe file: $EXEFILE -> $EXENAME (with space replaced by dot)"
          
          # 创建 latest.json (仅 Windows，macOS DMG 不支持自动更新)
          # 使用 printf 避免 YAML heredoc 解析问题
          DOWNLOAD_URL="https://github.com/${REPO}/releases/download/v${VERSION}/${EXENAME}"
          PUB_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          printf '{\n  "version": "%s",\n  "notes": "Open Switch v%s 发布",\n  "pub_date": "%s",\n  "platforms": {\n    "windows-x86_64": {\n      "signature": "%s",\n      "url": "%s"\n    }\n  }\n}\n' \
            "${VERSION}" "${VERSION}" "${PUB_DATE}" "${WIN_SIG}" "${DOWNLOAD_URL}" > artifacts/latest.json
          
          echo "Generated latest.json:"
          cat artifacts/latest.json
          
          # 验证签名不为空
          if [ -z "$WIN_SIG" ]; then
            echo "::warning::Signature is empty, auto-update will fail!"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.sig
            artifacts/latest.json
          draft: false
          generate_release_notes: true
          fail_on_unmatched_files: false
